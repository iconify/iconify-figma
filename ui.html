<div id="container"><p class="loading" style="padding: 24px;">Loading Iconify plug-in...</p></div>
<script>

(function() {
	var plugin = {
		load: {
			scripts: [
				{
					src: 'https://code.iconify.design/1/1.0.2/iconify.min.js',
					test: function() {
						return window.Iconify !== void 0;
					}
				},
				'https://code.iconify.design/samples.js',
				'https://code.iconify.design/search/1/1.0.3/search.min.js'
			],
			stylesheets: [
				'https://fonts.googleapis.com/css?family=PT+Sans',
				'https://code.iconify.design/search/1/1.0.3/style.css'
			],
			styles: [
				'html, body { margin: 0; padding: 0; } body { padding: 16px; background: #f2f2f2; }'
			]
		},
	};

	var loading = false,
		loaded = false;

	/**
	 * Call done() after test() is successful
	 *
	 * @param {function} test
	 * @param {function} done
	 */
	function delay(test, done) {
		var counter = 0,
			timer, result;

		function nextTick() {
			result = test();

			if (result) {
				// Success
				window.clearInterval(timer);
				done();
				return;
			}

			if (result === null) {
				// Stop execution
				window.clearInterval(timer);
				return;
			}

			// Test failed
			counter ++;
			if (counter === 10 || counter === 25) {
				// It takes too long. Reduce timeout
				window.clearInterval(timer);
				timer = window.setInterval(nextTick, counter === 10 ? 250 : 1000);
			}
		}

		// Do first test immediately
		result = test();
		if (result) {
			done();
			return;
		}
		if (result === null) {
			return;
		}

		// Create timer
		timer = window.setInterval(nextTick, 100);
	}

	/**
	 * Test if all dependencies have loaded
	 */
	function testDependencies() {
		return window.Iconify !== void 0 && window.IconifySearch !== void 0;
	}

	/**
	 * Load all dependencies, call done() when done
	 *
	 * @param {function} done
	 */
	function loadDependencies(done) {
		var scripts, style, el;

		function loadNextScript() {
			var item = scripts.shift(),
				src, el, test;

			if (item === void 0) {
				// Loaded all scripts
				console.log('Iconify debug: loaded all scripts, testing all dependencies...');
				delay(testDependencies, function() {
					console.log('Iconify debug: tested all dependencies, calling done()');
					loaded = true;
					loading = false;
					done();
				});
				return;
			}

			// Load script
			if (typeof item === 'string') {
				src = item;
			} else {
				src = item.src;
				test = item.test;
			}

			el = document.createElement('script');
			el.setAttribute('src', src);
			el.setAttribute('async', true);
			console.log('Iconify: loading script:', src);
			document.head.appendChild(el);

			// Wait for script to load
			if (typeof test !== 'function') {
				loadNextScript();
				return;
			}

			// Create timer to test
			delay(test, loadNextScript);
		}

		if (loaded) {
			done();
			return;
		}

		if (loading) {
			delay(testDependencies, done);
			return;
		}

		loading = true;

		// Load stylesheets
		plugin.load.stylesheets.forEach(function(src) {
			el = document.createElement('link');
			console.log('Iconify: loading stylesheet:', src);
			el.setAttribute('rel', 'stylesheet');
			el.setAttribute('type', 'text/css');
			el.setAttribute('href', src);
			document.head.appendChild(el);
		});

		// Merge custom styles
		style = plugin.load.styles.join('');
		el = document.createElement('style');
		el.setAttribute('type', 'text/css');
		el.innerText = style;
		document.head.appendChild(el);

		// Start loading scripts
		scripts = plugin.load.scripts.slice(0);
		loadNextScript();
	}


	/**
	 * Generate SVG from icon data
	 *
	 * @param icon
	 * @return {string|null}
	 */
	function generateSVG(icon) {
		var Iconify = window.Iconify,
			name, data, colorless, width, height, counter, params, code;

		name = icon.prefix + (icon.prefix.indexOf('-') === -1 ? '-' : ':') + icon.name;
		if (!Iconify.iconExists(name)) {
			return null;
		}

		data = Iconify.getIcon(name);
		if (data === null) {
			return null;
		}

		// Check if icon is colorless
		colorless = data.body.indexOf('currentColor') !== -1;

		// Scale icon
		width = data.width;
		height = data.height;
		counter = 0;
		while (true) {
			counter ++;
			if (counter > 8) {
				break;
			}
			if (height > 47 && width % 2 === 0 && height % 2 === 0) {
				width = width / 2;
				height = height / 2;
				continue;
			}
			if (height > 74 && width % 5 === 0 && height % 5 === 0) {
				width = width / 5;
				height = height / 5;
				break;
			}
			break;
		}

		// Generate SVG code
		// console.log('Data:', data);
		// console.log('Original size:', data.width, data.height, 'Scaled:', width, height);
		params = {
			'data-width': width,
			'data-height': height,
			'data-rotate': icon.rotate,
			'data-flip': (icon.hFlip ? (icon.vFlip ? 'horizontal,vertical' : 'horizontal') : (icon.vFlip ? 'vertical' : ''))
		};
		code = Iconify.getSVG(name, params);
		if (code === null) {
			return null;
		}

		// Replace color
		if (colorless) {
			code = code.replace(/currentColor/g, typeof icon.color === 'string' && icon.color.length ? icon.color : '#000');
		}

		return code;
	}

	// Load dependencies then show window
	loadDependencies(function() {
		var container = document.getElementById('container');
		window.IconifySearch.create(container, {
			// Uncomment next 2 lines and change value for 'prefix' to limit plug-in to one collection
			// prefix: 'mdi',
			// hidePrefix: true,

			// Uncomment next line and change value of 'precies' to list of prefixes to limit plug-in to several collections
			// prefixes: ['mdi', 'mdi-light'],

			listView: false,
			append: false,
			show: true,
			useForm: true,
			showCollections: true,
			footer: {
				submit: 'Add Icon',
				submit2: 'Add and Close',
				close: 'Close',
				transform: true,
				size: true,
				hideEmpty: true,
				color: true,
				defaultColor: '#000'
			},
			callback: function(event, icon) {
				var result = {
					event: event
				};

				switch (event) {
					case 'submit':
					case 'submit2':
						result.icon = icon;
						result.svg = generateSVG(icon);
					case 'cancel':
						parent.postMessage({
							pluginMessage: result
						}, '*');
				}
			}
		});
	});
})();

</script>
